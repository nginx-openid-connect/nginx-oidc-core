# IdP Configuration Variables for OpenID Connect

This directory provides the details of each variable which is related to [IdP configuration for the OpenID Connect](../../oidc_idp.conf).

- [Configuring OpenID Provider Metadata via Well-Known Endpoints](#configuring-openid-provider-metadata-via-well-known-endpoints)
- [Custom Configuration for Well-Known OIDC Endpoints](#custom-configuration-for-well-known-oidc-endpoints)
- [Advanced OIDC Configuration](#advanced-oidc-configuration)

<br>

## Configuring OpenID-Provider(IdP) Metadata via Well-Known Endpoints

Openid-configuration is a Well-known URI Discovery Mechanism for the Provider Configuration URI and is defined in OpenID Connect. The well-known endpoint returns OpenID Connect metadata about the authorization server. You could configure the following variables based on the well-known endpoint.

| Variable                  | Description                                                                                                           |
| ------------------------- | --------------------------------------------------------------------------------------------------------------------- |
| `$oidc_authz_endpoint`    | URL of the IdP's OAuth 2.0 Authorization Endpoint.                                                                    |
| `$oidc_jwt_keyfile`       | URL of the IdP's JSON Web Key Set document.                                                                           |
| `$oidc_logout_endpoint`   | URL of the IdP's end_session endpoint.                                                                                |
| `$oidc_token_endpoint`    | URL of the IdP's OAuth 2.0 Token Endpoint.                                                                            |
| `$oidc_userinfo_endpoint` | URL of the IdP's UserInfo Endpoint.                                                                                   |
| `$oidc_host`              | URL of the IdP's application. For example, `https://dev-xxxxx.okta.com`                                               |
| `$oidc_scopes`            | List of the OAuth 2.0 scope values that this server supports. <br> For example, `openid+profile+email+offline_access` |

<br>

## Custom Configuration for Well-Known OIDC Endpoints

This is for customers to customize the Well-Known OIDC endpoints to pass vendor specific query or path param to complete the flow. For eg: `Azure AD` B2B expects to send a special query param called resource-id to be passed to its authorization endpoint. Another example is that `Auth0` expects to send the a special query param called client-id & returnTo=LOGOUT_URL for its global logout.

| Variable                           | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `$oidc_authz_path_params_enable`   | `1`: Enable custom path params when `{arbitrary param-name}` is in the `$oidc_authz_endpoint`. <br> `0`: Disable it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `$oidc_authz_path_params`          | Use for when `$oidc_authz_path_params` is enabled. <br><br> **Example:** <br><pre>map $host $oidc_authz_endpoint { <br> default "https://{my-app}.okta.com/oauth2/{version}/authorize"; <br>} <br>map $host $oidc_authz_path_params { <br> default '{ "my-app": "dev-9590480", "version": "v1" }'; <br>}</pre>                                                                                                                                                                                                                                                                                                                             |
|                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `$oidc_authz_query_params_enable`  | `1`: Enable additional query params when the `$oidc_authz_endpoint` needs them. <br> `0`: Disable it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `$oidc_authz_query_params`         | Use for when `$oidc_authz_query_params_enable` is enabled. <br><br> **Example:** <br><pre> map $host $oidc_authz_query_params { <br> default '{ <br>     "response_type": "code", <br>     "scope"        : "$oidc_scopes", <br> "client_id" : "$oidc_client", <br>     "redirect_uri" : "$redirect_base$redir_location", <br>     "nonce"        : "$nonce_hash", <br> "state" : 0 <br> }'; <br>                                                                                                                                                                                                                                          |
|                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `$oidc_logout_path_params_enable`  | `1`: Enable custom path params when `{arbitrary param-name}` is in the `$oidc_logout_endpoint`. <br> `0`: Disable it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `$oidc_logout_path_params`         | Use for when `$oidc_logout_path_params_enable` is enabled. <br><br> **Example:** <br><pre>map $host $oidc_logout_endpoint { <br> default "https://{my-app}.okta.com/oauth2/{version}/logout"; <br>} <br>map $host $oidc_authz_path_params { <br> default '{ "my-app": "dev-9590480", "version": "v1" }'; <br>}</pre>                                                                                                                                                                                                                                                                                                                       |
|                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `$oidc_logout_query_params_enable` | `1`: Enable additional query params when the IdP doesn't support [OIDC RP-initiated logout](https://openid.net/specs/openid-connect-rpinitiated-1_0.html#RPLogout). <br> `0`: [OIDC RP-initiated logout](https://openid.net/specs/openid-connect-rpinitiated-1_0.html#RPLogout).                                                                                                                                                                                                                                                                                                                                                           |
| `$oidc_logout_query_params`        | Use for when `$oidc_logout_query_params_enable` is enabled. <br><br>**Example:**<pre> map $host $oidc_logout_query_params {<br>    # example 1. AWS Cognito Logout & prompt an user to sign in as another user.<br>    default '{<br>        "response_type": "code",<br>        "client_id"    : "$oidc_client",<br> "redirect_uri" : "$redirect_base$redir_location",<br> "state" : "STATE",<br> "scope" : "$oidc_scopes"<br>    }';<br><br>    # example 2. AWS Cognito Logout & redirect back to client. <br>    default '{<br>        "client_id"    : "$oidc_client",<br> "logout_uri" : "$redirect_base/\_logout"<br> }';</pre><br> |
|                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `$oidc_token_path_params_enable`   | `1`: Enable custom path params when `{arbitrary param-name}` is in the `$oidc_token_endpoint`. <br> `0`: Disable it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `$oidc_token_path_params`          | Use for when `$oidc_token_path_params_enable` is enabled. <br><br> **Example:** <br><pre>map $host $oidc_token_endpoint { <br> default "https://{my-app}.okta.com/oauth2/{version}/token"; <br>} <br>map $host $oidc_authz_path_params { <br> default '{ "my-app": "dev-9590480", "version": "v1" }'; <br>}</pre>                                                                                                                                                                                                                                                                                                                          |
|                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `$oidc_token_query_params_enable`  | `1`: Enable additional query params when the `$oidc_token_endpoint` needs them. <br> `0`: Disable it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `$oidc_token_query_params`         | Use for when `$oidc_token_query_params_enable` is enabled. <br><br> **Example:** <br><pre>map $host $oidc_token_query_params { <br> default '{ "example": "data" }'; <br>}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

<br>

## Advanced OIDC Configuration

| Variable                | Description                                                                                                                                                                                                                                                         |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `$oidc_client`          | IdP's client ID which is a public identifier for the client that is required for all OAuth flows.                                                                                                                                                                   |
| `$oidc_client_secret`   | IdP's client secret which is used by the client to exchange an authorization code for a token. <br> It should be empty value with `""` when PKCE is enabled.                                                                                                        |
| `$oidc_hmac_key`        | Hash-based message authentication code (or HMAC) is a cryptographic technique that combines public keys, private keys, and a hash into a mix hackers can't unpack. <br> It should be unique for every NGINX instance/cluster.                                       |
| `$oidc_logout_redirect` | URI to be redirected by the IdP after successful logout from the IdP. <br> This should be configured in your IdP.                                                                                                                                                   |
| `$oidc_pkce_enable`     | PKCE is an OAuth 2.0 security extension for public clients on mobile devices or single page apps intended to avoid a malicious programme creeping into the same computer from intercepting the authorisation code. <br><br> `1`: Enable PKCE <br> `0`: Disable PKCE |
| `$oidc_app_name`        | IdP's application name                                                                                                                                                                                                                                              |
